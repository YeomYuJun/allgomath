groups:
  # API 성능 알림
  - name: api_performance_alerts
    interval: 30s
    rules:
      # 평균 응답시간 초과
      - alert: HighAPILatency
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{uri!~"/actuator.*"}[5m])) by (le)) > 0.1
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API 응답시간 지연 (P95 > 100ms)"
          description: "지난 5분간 P95 응답시간이 {{ $value | humanizeDuration }}로 목표치(100ms)를 초과했습니다."

      # 극심한 응답시간 초과
      - alert: CriticalAPILatency
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{uri!~"/actuator.*"}[5m])) by (le)) > 0.5
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "API 응답시간 심각 지연 (P95 > 500ms)"
          description: "지난 2분간 P95 응답시간이 {{ $value | humanizeDuration }}로 심각하게 지연되고 있습니다."

      # 에러율 증가
      - alert: HighErrorRate
        expr: sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) / sum(rate(http_server_requests_seconds_count[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "높은 에러율 감지 (> 5%)"
          description: "지난 5분간 HTTP 5xx 에러율이 {{ $value | humanizePercentage }}입니다."

      # 처리량 급감
      - alert: LowThroughput
        expr: sum(rate(http_server_requests_seconds_count[5m])) < 1
        for: 10m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API 처리량 급감"
          description: "지난 10분간 API 요청이 분당 {{ $value }}건으로 비정상적으로 낮습니다."

  # Redis 캐시 알림
  - name: redis_cache_alerts
    interval: 30s
    rules:
      # Redis 연결 끊김
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          component: redis
        annotations:
          summary: "Redis 서버 다운"
          description: "Redis 서버가 1분 이상 응답하지 않습니다."

      # 캐시 히트율 저하
      - alert: LowCacheHitRate
        expr: sum(rate(redis_keyspace_hits_total[5m])) / (sum(rate(redis_keyspace_hits_total[5m])) + sum(rate(redis_keyspace_misses_total[5m]))) < 0.5
        for: 10m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Redis 캐시 히트율 저하 (< 50%)"
          description: "지난 10분간 캐시 히트율이 {{ $value | humanizePercentage }}로 낮습니다. 목표치는 85%입니다."

      # Redis 메모리 사용률 높음
      - alert: HighRedisMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
        for: 5m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Redis 메모리 사용률 높음 (> 80%)"
          description: "Redis 메모리 사용률이 {{ $value | humanizePercentage }}입니다. 곧 메모리 부족이 예상됩니다."

      # Redis 연결 수 급증
      - alert: HighRedisConnections
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Redis 연결 수 급증"
          description: "현재 Redis 연결 수가 {{ $value }}개입니다. 연결 풀 설정을 확인하세요."

  # JVM 및 시스템 알림
  - name: jvm_system_alerts
    interval: 30s
    rules:
      # JVM 메모리 부족
      - alert: HighJVMMemoryUsage
        expr: (sum(jvm_memory_used_bytes{area="heap"}) / sum(jvm_memory_max_bytes{area="heap"})) > 0.85
        for: 5m
        labels:
          severity: warning
          component: jvm
        annotations:
          summary: "JVM Heap 메모리 사용률 높음 (> 85%)"
          description: "JVM Heap 메모리 사용률이 {{ $value | humanizePercentage }}입니다. OOM 위험이 있습니다."

      # GC 시간 과다
      - alert: HighGCTime
        expr: rate(jvm_gc_pause_seconds_sum[5m]) / rate(jvm_gc_pause_seconds_count[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: jvm
        annotations:
          summary: "GC 시간 과다 (평균 > 100ms)"
          description: "지난 5분간 평균 GC 시간이 {{ $value | humanizeDuration }}입니다."

      # CPU 사용률 높음
      - alert: HighCPUUsage
        expr: process_cpu_usage > 0.8
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "높은 CPU 사용률 (> 80%)"
          description: "지난 10분간 CPU 사용률이 {{ $value | humanizePercentage }}로 높습니다."

      # 스레드 수 과다
      - alert: HighThreadCount
        expr: jvm_threads_live_threads > 200
        for: 5m
        labels:
          severity: warning
          component: jvm
        annotations:
          summary: "활성 스레드 수 과다"
          description: "현재 활성 스레드가 {{ $value }}개입니다. 스레드 풀 설정을 확인하세요."

  # 서비스 가용성 알림
  - name: service_availability_alerts
    interval: 30s
    rules:
      # Spring Boot 애플리케이션 다운
      - alert: AllgoMathAPIDown
        expr: up{job="allgomath-api"} == 0
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "AllgoMath API 서버 다운"
          description: "AllgoMath API 서버가 2분 이상 응답하지 않습니다. 즉시 확인이 필요합니다."

      # Prometheus 자체 다운
      - alert: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 2m
        labels:
          severity: critical
          component: monitoring
        annotations:
          summary: "Prometheus 다운"
          description: "Prometheus 모니터링 시스템이 다운되었습니다."

      # Health Check 실패
      - alert: HealthCheckFailed
        expr: up{job="allgomath-api"} == 1 and on() (absent(up{job="allgomath-api"}) or on() vector(0))
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "헬스체크 실패"
          description: "API 서버가 실행 중이지만 헬스체크가 실패하고 있습니다."

  # 알고리즘 성능 알림 (커스텀 메트릭)
  - name: algorithm_performance_alerts
    interval: 30s
    rules:
      # FFT 계산 시간 초과
      - alert: SlowFFTCalculation
        expr: histogram_quantile(0.95, rate(algorithm_execution_time_seconds_bucket{algorithm="fft"}[5m])) > 1.0
        for: 5m
        labels:
          severity: warning
          component: algorithm
        annotations:
          summary: "FFT 계산 느림 (P95 > 1초)"
          description: "FFT 알고리즘 P95 실행시간이 {{ $value | humanizeDuration }}입니다."

      # Monte Carlo 계산 시간 초과
      - alert: SlowMonteCarloCalculation
        expr: histogram_quantile(0.95, rate(algorithm_execution_time_seconds_bucket{algorithm="monte-carlo"}[5m])) > 2.0
        for: 5m
        labels:
          severity: warning
          component: algorithm
        annotations:
          summary: "Monte Carlo 계산 느림 (P95 > 2초)"
          description: "Monte Carlo 알고리즘 P95 실행시간이 {{ $value | humanizeDuration }}입니다."

      # Fractal 계산 시간 초과
      - alert: SlowFractalCalculation
        expr: histogram_quantile(0.95, rate(algorithm_execution_time_seconds_bucket{algorithm="fractal"}[5m])) > 3.0
        for: 5m
        labels:
          severity: warning
          component: algorithm
        annotations:
          summary: "Fractal 계산 느림 (P95 > 3초)"
          description: "Fractal 알고리즘 P95 실행시간이 {{ $value | humanizeDuration }}입니다."
