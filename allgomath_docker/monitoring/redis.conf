# ================================================
# AllgoMath Production Redis Configuration
# ================================================

# 네트워크 설정
bind 0.0.0.0
port 6379
tcp-backlog 511
tcp-keepalive 300
timeout 0

# 보안 설정
# requirepass YOUR_STRONG_PASSWORD_HERE  # 운영 환경에서는 반드시 설정!
# 외부 접근 차단을 위해 Docker 네트워크 내에서만 접근 허용

# 메모리 관리
maxmemory 2gb
# 메모리 부족시 LRU로 오래된 키 삭제
maxmemory-policy allkeys-lru 
maxmemory-samples 5

# 영속성 설정 (RDB)
# 운영 환경: 빈번한 저장으로 데이터 손실 최소화
 # 15분 내 1번 이상 변경
save 900 1 
# 5분 내 10번 이상 변경
save 300 10   
 # 1분 내 10000번 이상 변경
save 60 10000 
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# AOF (Append Only File) 설정 - 추가 안정성
# 성능 우선, 필요시 yes로 변경
appendonly no
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# 로그 설정
loglevel notice
logfile ""
syslog-enabled no

# 클라이언트 연결
maxclients 10000

# 슬로우 로그 (성능 모니터링)
 # 10ms 이상 걸리는 명령어 로깅
slowlog-log-slower-than 10000 
slowlog-max-len 128

# 고급 설정
databases 16
always-show-logo yes

# 메모리 최적화
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100

# 활성 디프래그먼테이션 (메모리 단편화 방지)
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# Latency 모니터링
# 100ms 이상 지연 시 로깅
latency-monitor-threshold 100

# 클라이언트 출력 버퍼
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Redis Cluster (향후 확장용 - 현재는 단일 인스턴스)
# cluster-enabled no

# Sentinel 설정 (향후 고가용성 구성용)
# sentinel monitor mymaster 127.0.0.1 6379 2
# sentinel down-after-milliseconds mymaster 5000
# sentinel parallel-syncs mymaster 1
# sentinel failover-timeout mymaster 10000
